{
    # Enable FrankenPHP
    frankenphp

    # Enable Mercure hub
    order mercure after encode
}

:80 {
    root * /app/webroot
    encode zstd gzip

    # CORS headers for Mercure
    @mercure path /.well-known/mercure
    handle @mercure {
        header Access-Control-Allow-Origin "https://franken.dereuromark.de"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Last-Event-ID, Authorization"
        header Access-Control-Allow-Credentials "true"

        @options method OPTIONS
        respond @options 204

        mercure {
            publisher_jwt {env.MERCURE_PUBLISHER_JWT_KEY}
            subscriber_jwt {env.MERCURE_SUBSCRIBER_JWT_KEY}
            anonymous
            subscriptions
        }
    }

    # PHP handling via FrankenPHP
    php_server {
        root /app/webroot
    }
}
